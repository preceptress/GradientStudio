<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gradient Studio ‚Äî One-Stop Background & Theme Generator</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --bg:#0b0c10;
    --panel:#12141a;
    --border:#222631;
    --ink:#f5f5f5;
    --muted:#9aa4b2;
  }
  body{
    background:radial-gradient(1200px 600px at 80% -10%, #1d2240 0%, #0b0c10 60%) fixed;
    color:var(--ink);
  }
  .card{ background:rgba(18,20,26,.92); border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .form-control, .form-control:focus{ background:#0e1117; color:var(--ink); border-color:var(--border); }
  .preview{ width:100%; height:320px; border-radius:16px; border:1px solid var(--border); }
  .stop-row{ display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem; }
  .stop-row input[type="color"]{ width:44px; height:36px; padding:2px; }
  .stop-row .pos, .stop-row .opa{ width:90px; }
  .sortable-handle{ cursor:grab; user-select:none; opacity:.9; }
  /* Unified code block style + wrapping */
  pre code{
    display:block;
    background:#0e1117;
    color:#e6e6e6;
    padding:1rem;
    border:1px solid var(--border);
    border-radius:.5rem;
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:.9rem;
    line-height:1.4;
    white-space:pre-wrap;     /* wrap long lines */
    word-break:break-word;    /* avoid overflow */
    overflow-x:hidden;        /* no horizontal scroll */
    min-height:160px;
  }
  .copy-btn{ font-size:.75rem; padding:.25rem .5rem; }
  footer.card{ border-radius:.75rem; }

  /* iPhone mock (compact) */
.iphone-mock{
  position: relative;
  width: 280px;
  height: 560px;
  border-radius: 46px;
  background: #0f1117;
  border: 2px solid rgba(255,255,255,0.15);
  box-shadow: 0 20px 60px rgba(0,0,0,.45), inset 0 0 0 6px rgba(255,255,255,0.04);
}
.iphone-notch{
  position:absolute;
  top: 8px; left:50%; transform:translateX(-50%);
  width: 160px; height: 24px;
  background:#0f1117;
  border-bottom-left-radius:16px; border-bottom-right-radius:16px;
}
.iphone-screen{
  position:absolute;
  inset: 10px;
  border-radius: 38px;
  overflow:hidden;
  background:#000; /* replaced live */
  display:flex; align-items:flex-end; justify-content:center;
  padding: 16px;
}
.iphone-caption{
  color:#e6e6e6; font-size:.85rem; opacity:.85;
  background: rgba(0,0,0,.25); padding:.25rem .6rem; border-radius:.5rem;
  border:1px solid rgba(255,255,255,.12);
}

/* Code blocks wrap nicely */
pre code{
  display:block;
  background:#0e1117;
  color:#e6e6e6;
  padding:1rem;
  border:1px solid var(--border, #333);
  border-radius:.5rem;
  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  font-size:.9rem;
  line-height:1.4;
  white-space:pre-wrap;
  word-break:break-word;
  overflow-x:hidden;
  min-height:140px;
}

/* Small copy button */
.copy-btn{ font-size:.75rem; padding:.25rem .5rem; }

/* Make all headings bright off-white */
h1, h2, h3, h4, h5, h6 {
  color: #f9f9f9 !important;   /* stronger off-white */
  font-weight: 600;            /* keep them bold enough */
}

/* Optional: also fix Bootstrap card titles/subtitles */
.card-title, .card-subtitle {
  color: #f9f9f9 !important;
}

/* Page header (title + subtitle) */
.hero-title   { color:#f9f9f9; font-weight:700; letter-spacing:.2px; }
.hero-subtitle{ color:#e2e6ee; opacity:.95; font-size:1.05rem; }

</style>
</head>
<body>

<main class="container my-4">

  <!-- Page header -->
<header class="py-2 mb-3">
  <h1 class="hero-title mb-1">Gradient Studio</h1>
  <div class="hero-subtitle">One-Stop Background &amp; Theme Generator</div>
</header>

  <!-- Designer / Controls -->
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card p-3">
        <h2 class="h5 mb-3">Designer</h2>

        <div class="mb-3">
          <label class="form-label me-2">Type</label>
          <div class="btn-group">
            <input type="radio" class="btn-check" name="gtype" id="typeLinear" checked>
            <label class="btn btn-outline-light btn-sm" for="typeLinear">Linear</label>
            <input type="radio" class="btn-check" name="gtype" id="typeRadial">
            <label class="btn btn-outline-light btn-sm" for="typeRadial">Radial</label>
            <input type="radio" class="btn-check" name="gtype" id="typeAngular">
            <label class="btn btn-outline-light btn-sm" for="typeAngular">Angular</label>
          </div>
        </div>

        <!-- Linear -->
        <div id="linearControls" class="mb-3">
          <label class="form-label">Angle (¬∞)</label>
          <input type="range" id="angle" class="form-range" min="0" max="360" step="1" value="90">
          <div><code id="angleVal">90¬∞</code></div>
        </div>

        <!-- Radial -->
        <div id="radialControls" class="mb-3" style="display:none;">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Center X (%)</label>
              <input type="number" id="centerX" class="form-control" min="0" max="100" value="50">
            </div>
            <div class="col-6">
              <label class="form-label">Center Y (%)</label>
              <input type="number" id="centerY" class="form-control" min="0" max="100" value="50">
            </div>
            <div class="col-6">
              <label class="form-label">Start radius (%)</label>
              <input type="number" id="startR" class="form-control" min="0" max="100" value="0">
            </div>
            <div class="col-6">
              <label class="form-label">End radius (%)</label>
              <input type="number" id="endR" class="form-control" min="1" max="100" value="100">
            </div>
          </div>
        </div>

        <!-- Angular -->
        <div id="angularControls" class="mb-3" style="display:none;">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Center X (%)</label>
              <input type="number" id="aCenterX" class="form-control" min="0" max="100" value="50">
            </div>
            <div class="col-6">
              <label class="form-label">Center Y (%)</label>
              <input type="number" id="aCenterY" class="form-control" min="0" max="100" value="50">
            </div>
            <div class="col-12">
              <label class="form-label">Start Angle (¬∞)</label>
              <input type="range" id="aStartAngle" class="form-range" min="0" max="360" value="0">
              <div><code id="aStartAngleVal">0¬∞</code></div>
            </div>
          </div>
        </div>

        <!-- Stops -->
        <div>
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="h6 mb-0">Stops</h3>
            <div class="text-secondary small">drag ‚ò∞ to reorder</div>
          </div>
          <div id="stops" class="mt-2"></div>
          <div class="d-flex gap-2 mt-2">
            <button id="addStop" class="btn btn-outline-light btn-sm">+ Add stop</button>
            <button id="resetStops" class="btn btn-outline-warning btn-sm">Reset</button>
          </div>
        </div>

        <hr class="my-3">

        <!-- PNG export -->
        <div class="row g-2 align-items-end">
          <div class="col-6 col-md-4">
            <label class="form-label">PNG size (px)</label>
            <input type="number" id="pngSize" class="form-control" min="64" value="1000">
          </div>
          <div class="col-6 col-md-4">
            <button id="downloadPNG" class="btn btn-primary w-100">Download PNG</button>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">PNG Pack sizes</label>
            <input type="text" id="packSizes" class="form-control" value="256, 512, 1024, 2000">
          </div>
          <div class="col-12 col-md-4">
            <button id="downloadPack" class="btn btn-outline-light w-100">Export PNG Pack</button>
          </div>

          <button id="exportIOSZip" class="btn btn-primary">Export iOS Demo (ZIP)</button>
        </div>
      </div>
    </div>

    <!-- Preview + Collection -->
    <div class="col-lg-6">
      <div class="card p-3">
        <h2 class="h6 mb-3">Preview</h2>
        <div id="preview" class="preview"></div>
      </div>

      <div class="card p-3 mt-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Gradient name</label>
            <input id="gradName" class="form-control" value="myGradient">
          </div>
          <div class="col-md-6 d-grid">
            <button id="addToCollection" class="btn btn-success">Add to Collection</button>
          </div>
        </div>
        <div class="d-flex align-items-center gap-3 mt-2 flex-wrap">
          <span class="text-secondary">Collection: <span id="collectionCount">0</span> item(s)</span>
          <div class="ms-auto d-flex gap-2">
            <button id="saveBrowser" class="btn btn-outline-light btn-sm">Save to Browser</button>
            <button id="clearSaved" class="btn btn-outline-warning btn-sm">Clear Saved</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Exporters + Code -->
    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex flex-wrap gap-2">
          <button id="exportSwift" class="btn btn-outline-light">Export Theme.swift</button>
          <button id="exportCSS" class="btn btn-outline-light">Export CSS</button>
          <button id="exportJSON" class="btn btn-outline-light">Export JSON</button>
          <label class="btn btn-outline-light mb-0">Import JSON <input id="importJSON" type="file" accept="application/json" hidden></label>
          <button id="clearCollection" class="btn btn-outline-danger">Clear Collection</button>
        </div>
        <hr>
        <div class="row g-3">
          <div class="col-md-6">
            <h2 class="h6 d-flex justify-content-between align-items-center">
              SwiftUI (current gradient)
              <button class="btn btn-sm btn-outline-light copy-btn" data-target="swiftCode">Copy</button>
            </h2>
            <pre><code id="swiftCode"></code></pre>
          </div>
          <div class="col-md-6">
            <h2 class="h6 d-flex justify-content-between align-items-center">
              CSS (current gradient)
              <button class="btn btn-sm btn-outline-light copy-btn" data-target="cssCode">Copy</button>
            </h2>
            <pre><code id="cssCode"></code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Mini Preview + Code (just above footer) -->
<div class="container my-4">
  <div class="card p-3">
    <h2 class="h6 mb-3">Prototype & Code</h2>

    <div class="row g-3">
      <!-- iPhone mock -->
      <div class="col-lg-4 d-flex justify-content-center">
        <div class="iphone-mock">
          <div class="iphone-notch"></div>
          <div class="iphone-screen" id="iphoneScreenMini">
            <div class="iphone-caption">Live preview</div>
          </div>
        </div>
      </div>

      <!-- Code blocks -->
      <div class="col-lg-8">
        <div class="row g-3">
          <div class="col-12">
            <h3 class="h6 d-flex justify-content-between align-items-center">
              SwiftUI (current gradient)
              <button class="btn btn-sm btn-outline-light copy-btn" data-target="swiftCodeMini">Copy</button>
            </h3>
            <pre><code id="swiftCodeMini"></code></pre>
          </div>
          <div class="col-12">
            <h3 class="h6 d-flex justify-content-between align-items-center">
              CSS (current gradient)
              <button class="btn btn-sm btn-outline-light copy-btn" data-target="cssCodeMini">Copy</button>
            </h3>
            <pre><code id="cssCodeMini"></code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Footer (card, same width) -->
<div class="container my-4">
  <footer class="card bg-dark text-light">
    <div class="card-body text-center">
      <p class="mb-2">
        <strong>Developers:</strong>
        <a href="https://preceptress.ai" target="_blank" rel="noopener noreferrer" class="text-info text-decoration-none">
          TeamApex ‚Äî Preceptress.ai
        </a>
        (AI X SwiftUI)
      </p>
      <p class="mb-2">
        <strong>Contact:</strong>
        <a href="mailto:friends@preceptress.ai" class="text-decoration-none text-info">
          friends@preceptress.ai
        </a>
      </p>
      <p class="small mb-2 text-secondary">
        ‚ö†Ô∏è Some browsers block email links. If clicking doesn‚Äôt work,
        <a href="#" id="copyEmailLink" class="text-info text-decoration-underline">click here</a>
        to copy the address and paste it into your email app.
      </p>
      <p class="mb-0 small text-light">
        <strong>Privacy Statement:</strong> We respect your privacy. We save minimal user data for functionality,
        and we do not share any data. Google Analytics is used for anonymous usage insights only.
      </p>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- small helpers ---
  const $ = id => document.getElementById(id);
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  function hexToRgbA(hex, a=1){
    hex = hex.replace('#','');
    if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
    const n = parseInt(hex,16);
    return {r:(n>>16)&255,g:(n>>8)&255,b:n&255,a:Math.min(1,Math.max(0,a))};
  }
  function rgbToSwift({r,g,b,a}){
    const f = n => (n/255).toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
    const af = a.toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
    return `Color(red: ${f(r)}, green: ${f(g)}, blue: ${f(b)}, opacity: ${af})`;
  }
  const cssStop = s => {
    const {r,g,b,a} = hexToRgbA(s.color, s.opacity);
    return `rgba(${r},${g},${b},${a}) ${s.pos}%`;
  };

  // --- UI refs ---
  const typeLinear  = $('typeLinear');
  const typeRadial  = $('typeRadial');
  const typeAngular = $('typeAngular');
  const linearControls  = $('linearControls');
  const radialControls  = $('radialControls');
  const angularControls = $('angularControls');

  const angleEl = $('angle'), angleVal = $('angleVal');
  const cX = $('centerX'), cY = $('centerY'), sR = $('startR'), eR = $('endR');
  const aCX = $('aCenterX'), aCY = $('aCenterY'), aStart = $('aStartAngle'), aStartVal = $('aStartAngleVal');

  const stopsEl = $('stops'), preview = $('preview');
  const swiftCodeEl = $('swiftCode'), cssCodeEl = $('cssCode');
  const pngSizeEl = $('pngSize'), packSizesEl = $('packSizes'), gradNameEl = $('gradName');

  // --- stops management ---
  function makeStopRow({color='#1a1a40', pos=0, opacity=1}={}){
    const row = document.createElement('div'); row.className='stop-row'; row.draggable = true;
    const handle = document.createElement('span'); handle.className='sortable-handle'; handle.textContent='‚ò∞';
    const picker = document.createElement('input'); picker.type='color'; picker.value=color; picker.className='form-control form-control-color'; picker.addEventListener('input',updateAll);
    const posInput = document.createElement('input'); posInput.type='number'; posInput.className='form-control pos'; posInput.min='0'; posInput.max='100'; posInput.value=String(pos);
    posInput.addEventListener('input',()=>{ posInput.value = String(clamp(Number(posInput.value||0),0,100)); updateAll(); });
    const pct = document.createElement('span'); pct.className='text-secondary'; pct.textContent='%';
    const opaInput = document.createElement('input'); opaInput.type='number'; opaInput.className='form-control opa'; opaInput.min='0'; opaInput.max='1'; opaInput.step='0.01'; opaInput.value=String(opacity);
    opaInput.addEventListener('input',()=>{ opaInput.value=String(clamp(Number(opaInput.value||1),0,1)); updateAll(); });
    const opaLbl = document.createElement('span'); opaLbl.className='text-secondary'; opaLbl.textContent='opacity';
    const del = document.createElement('button'); del.className='btn btn-outline-danger btn-sm'; del.textContent='Remove';
    del.addEventListener('click',()=>{ if(stopsEl.children.length>2){ row.remove(); updateAll(); }});

    // drag sorting
    row.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain','drag'); row.classList.add('opacity-75'); window._dragEl=row; });
    row.addEventListener('dragend', ()=>{ row.classList.remove('opacity-75'); window._dragEl=null; updateAll(); });
    row.addEventListener('dragover', e=>{ e.preventDefault(); if(!window._dragEl || window._dragEl===row) return;
      const rect=row.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2;
      stopsEl.insertBefore(window._dragEl, before?row:row.nextSibling);
    });

    [handle,picker,posInput,pct,opaInput,opaLbl,del].forEach(n=>row.appendChild(n));
    return row;
  }

  function readStops(){
    const arr=[];
    [...stopsEl.children].forEach(row=>{
      const inputs=row.querySelectorAll('input');
      arr.push({ color: inputs[0].value, pos: clamp(Number(inputs[1].value||0),0,100), opacity: clamp(Number(inputs[2].value||1),0,1) });
    });
    arr.sort((a,b)=>a.pos-b.pos);
    return arr;
  }

  // --- preview + code generation ---
  function updatePreview(){
    const stops=readStops();
    let css;
    if(typeLinear.checked){
      css = `linear-gradient(${Number(angleEl.value||0)}deg, ${stops.map(cssStop).join(', ')})`;
    }else if(typeRadial.checked){
      css = `radial-gradient(circle at ${clamp(Number(cX.value||50),0,100)}% ${clamp(Number(cY.value||50),0,100)}%, ${stops.map(cssStop).join(', ')})`;
    }else{
      css = `conic-gradient(from ${Number(aStart.value||0)}deg at ${clamp(Number(aCX.value||50),0,100)}% ${clamp(Number(aCY.value||50),0,100)}%, ${stops.map(cssStop).join(', ')})`;
    }
    preview.style.background = css;
    cssCodeEl.textContent = `background: ${css};`;
  }

  function updateSwift(){
    const stops=readStops();
    const swiftColors = stops.map(s=>rgbToSwift(hexToRgbA(s.color, s.opacity))).join(",\n        ");

    if(typeLinear.checked){
      const ang=Number(angleEl.value||0)*Math.PI/180; const vx=Math.cos(ang), vy=Math.sin(ang);
      const m=Math.max(Math.abs(vx),Math.abs(vy))||1; const nx=vx/m, ny=vy/m;
      const sx=(0.5-0.5*nx).toFixed(3), sy=(0.5-0.5*ny).toFixed(3), ex=(0.5+0.5*nx).toFixed(3), ey=(0.5+0.5*ny).toFixed(3);
      swiftCodeEl.textContent =
`let gradient = LinearGradient(
    gradient: Gradient(colors: [
        ${swiftColors}
    ]),
    startPoint: UnitPoint(x: ${sx}, y: ${sy}),
    endPoint: UnitPoint(x: ${ex}, y: ${ey})
)`;
    }else if(typeRadial.checked){
      const cx=(clamp(Number(cX.value||50),0,100)/100).toFixed(3);
      const cy=(clamp(Number(cY.value||50),0,100)/100).toFixed(3);
      const sr=(clamp(Number(sR.value||0),0,100)/100).toFixed(3);
      const er=(clamp(Number(eR.value||100),1,100)/100).toFixed(3);
      swiftCodeEl.textContent =
`let gradient = RadialGradient(
    gradient: Gradient(colors: [
        ${swiftColors}
    ]),
    center: UnitPoint(x: ${cx}, y: ${cy}),
    startRadius: ${sr},
    endRadius: ${er}
)`;
    }else{
      const cx=(clamp(Number(aCX.value||50),0,100)/100).toFixed(3);
      const cy=(clamp(Number(aCY.value||50),0,100)/100).toFixed(3);
      const sa=Number(aStart.value||0);
      swiftCodeEl.textContent =
`let gradient = AngularGradient(
    gradient: Gradient(colors: [
        ${swiftColors}
    ]),
    center: UnitPoint(x: ${cx}, y: ${cy}),
    startAngle: .degrees(${sa}),
    endAngle: .degrees(${sa+360})
)`;
    }
  }

  function updateAll(){
    $('angleVal').textContent = `${angleEl.value}¬∞`;
    $('aStartAngleVal').textContent = `${aStart.value}¬∞`;
    updatePreview(); updateSwift();
  }

  // --- PNG generation (canvas) ---
  const canvas = document.createElement('canvas');
  function drawToCanvas(side){
    canvas.width=side; canvas.height=side;
    const ctx=canvas.getContext('2d');
    const stops=readStops();

    if(typeLinear.checked){
      const ang=Number(angleEl.value||0)*Math.PI/180;
      const vx=Math.cos(ang), vy=Math.sin(ang);
      const m=Math.max(Math.abs(vx),Math.abs(vy))||1; const nx=vx/m, ny=vy/m;
      const sx=(0.5-0.5*nx)*side, sy=(0.5-0.5*ny)*side, ex=(0.5+0.5*nx)*side, ey=(0.5+0.5*ny)*side;
      const g=ctx.createLinearGradient(sx,sy,ex,ey);
      stops.forEach(s=>{ const {r,g:gg,b,a}=hexToRgbA(s.color,s.opacity); g.addColorStop(s.pos/100,`rgba(${r},${gg},${b},${a})`); });
      ctx.fillStyle=g; ctx.fillRect(0,0,side,side);
    }else if(typeRadial.checked){
      const cxp=clamp(Number(cX.value||50),0,100)/100*side, cyp=clamp(Number(cY.value||50),0,100)/100*side;
      const srp=clamp(Number(sR.value||0),0,100)/100*(side/2), erp=clamp(Number(eR.value||100),1,100)/100*(side/2);
      const g=ctx.createRadialGradient(cxp,cyp,srp,cxp,cyp,erp);
      stops.forEach(s=>{ const {r,g:gg,b,a}=hexToRgbA(s.color,s.opacity); g.addColorStop(s.pos/100,`rgba(${r},${gg},${b},${a})`); });
      ctx.fillStyle=g; ctx.fillRect(0,0,side,side);
    }else{
      const cxp=clamp(Number(aCX.value||50),0,100)/100*side, cyp=clamp(Number(aCY.value||50),0,100)/100*side;
      const sa=Number(aStart.value||0)*Math.PI/180, steps=720;
      for(let i=0;i<steps;i++){
        const t=i/steps, p=t*100, arr=readStops();
        let c1=arr[0], c2=arr[arr.length-1];
        for(let k=0;k<arr.length-1;k++){ if(p>=arr[k].pos && p<=arr[k+1].pos){ c1=arr[k]; c2=arr[k+1]; break; } }
        const denom=(c2.pos-c1.pos)||1, tt=Math.min(1,Math.max(0,(p-c1.pos)/denom));
        const A=hexToRgbA(c1.color,c1.opacity), B=hexToRgbA(c2.color,c2.opacity);
        const lerp=(a,b)=>a+(b-a)*tt;
        const r=Math.round(lerp(A.r,B.r)), g=Math.round(lerp(A.g,B.g)), b=Math.round(lerp(A.b,B.b)), a=lerp(A.a,B.a);
        const a1=sa+t*2*Math.PI, a2=sa+(t+1/steps)*2*Math.PI;
        ctx.beginPath(); ctx.moveTo(cxp,cyp); ctx.arc(cxp,cyp,side,a1,a2); ctx.closePath();
        ctx.fillStyle=`rgba(${r},${g},${b},${a})`; ctx.fill();
      }
    }
  }
  function downloadPNG(){
    const side=Math.max(64, Number(pngSizeEl.value||1000));
    drawToCanvas(side);
    const url=canvas.toDataURL('image/png');
    const a=document.createElement('a'); a.href=url; a.download='gradient.png';
    document.body.appendChild(a); a.click(); a.remove();
  }
  function parsePackSizes(){
    return (packSizesEl.value||'').split(',').map(s=>Number(String(s).trim())).filter(n=>Number.isFinite(n) && n>=32 && n<=16384);
  }
  function downloadPack(){
    const sizes=parsePackSizes(); if(!sizes.length){ alert('Enter sizes like: 256, 512, 1024'); return; }
    const base=(gradNameEl.value||'gradient').replace(/\W+/g,'') || 'gradient';
    (async()=>{ for(const side of sizes){ drawToCanvas(side); const url=canvas.toDataURL('image/png'); await new Promise(r=>setTimeout(r,30));
      const a=document.createElement('a'); a.href=url; a.download=`${base}-${side}.png`; document.body.appendChild(a); a.click(); a.remove(); } })();
  }

  // --- exports / collection ---
  let collection=[]; const collectionCountEl=$('collectionCount'); const importJSONEl=$('importJSON');
  function currentSpec(){
    const stops=readStops();
    if(typeLinear.checked) return {type:'linear', angle:Number(angleEl.value||0), stops};
    if(typeRadial.checked) return {type:'radial', centerX:Number(cX.value||50), centerY:Number(cY.value||50), startR:Number(sR.value||0), endR:Number(eR.value||100), stops};
    return {type:'angular', centerX:Number(aCX.value||50), centerY:Number(aCY.value||50), startAngle:Number(aStart.value||0), stops};
  }
  function addToCollection(){
    let name=(gradNameEl.value||'myGradient').replace(/\W+/g,''); if(!name) name='myGradient';
    collection = collection.filter(g=>g.name!==name);
    collection.push({name, ...currentSpec()});
    collectionCountEl.textContent = String(collection.length);
    maybePersistCollection();
  }
  function toCssStops(stops){ return stops.map(cssStop).join(', '); }
  function downloadFile(fname, mime, text){
    const blob = new Blob([text], {type: mime}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportCSS(){
    let out=`/* Generated by Gradient Studio */\n:root{\n`;
    collection.forEach(g=>{
      if(g.type==='linear') out += `  --g-${g.name}: linear-gradient(${g.angle}deg, ${toCssStops(g.stops)});\n`;
      else if(g.type==='radial') out += `  --g-${g.name}: radial-gradient(circle at ${g.centerX}% ${g.centerY}%, ${toCssStops(g.stops)});\n`;
      else out += `  --g-${g.name}: conic-gradient(from ${g.startAngle}deg at ${g.centerX}% ${g.centerY}%, ${toCssStops(g.stops)});\n`;
    });
    out+=`}\n\n`; collection.forEach(g=>{ out+=`.bg-${g.name}{ background: var(--g-${g.name}); }\n`; });
    downloadFile('theme.css','text/css',out);
  }
  function exportJSON(){ downloadFile('gradients.json','application/json', JSON.stringify(collection,null,2)); }
  function importJSON(file){ const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(!Array.isArray(arr)) throw new Error('Invalid JSON'); collection=arr; collectionCountEl.textContent=String(collection.length); maybePersistCollection(); alert(`Imported ${collection.length} gradient(s).`);}catch(e){alert('Import failed: '+e.message);} }; r.readAsText(file); }
  function exportSwift(){
    let out=`// Generated by Gradient Studio\nimport SwiftUI\n\nstruct Theme {\n`;
    collection.forEach(g=>{
      const colors=g.stops.map(s=>rgbToSwift(hexToRgbA(s.color,s.opacity))).join(",\n                ");
      if(g.type==='linear'){
        const ang=g.angle*Math.PI/180, vx=Math.cos(ang), vy=Math.sin(ang), m=Math.max(Math.abs(vx),Math.abs(vy))||1, nx=vx/m, ny=vy/m;
        const sx=(0.5-0.5*nx).toFixed(3), sy=(0.5-0.5*ny).toFixed(3), ex=(0.5+0.5*nx).toFixed(3), ey=(0.5+0.5*ny).toFixed(3);
        out+=`
    static let ${g.name} = LinearGradient(
        gradient: Gradient(colors: [
                ${colors}
        ]),
        startPoint: UnitPoint(x: ${sx}, y: ${sy}),
        endPoint: UnitPoint(x: ${ex}, y: ${ey})
    )\n`;
      }else if(g.type==='radial'){
        const cx=(g.centerX/100).toFixed(3), cy=(g.centerY/100).toFixed(3), sr=(g.startR/100).toFixed(3), er=(g.endR/100).toFixed(3);
        out+=`
    static let ${g.name} = RadialGradient(
        gradient: Gradient(colors: [
                ${colors}
        ]),
        center: UnitPoint(x: ${cx}, y: ${cy}),
        startRadius: ${sr},
        endRadius: ${er}
    )\n`;
      }else{
        const cx=(g.centerX/100).toFixed(3), cy=(g.centerY/100).toFixed(3), sa=g.startAngle|0, ea=sa+360;
        out+=`
    static let ${g.name} = AngularGradient(
        gradient: Gradient(colors: [
                ${colors}
        ]),
        center: UnitPoint(x: ${cx}, y: ${cy}),
        startAngle: .degrees(${sa}),
        endAngle: .degrees(${ea})
    )\n`;
      }
    }); out+=`}\n`; downloadFile('Theme.swift','text/plain', out);
  }

  // --- local storage helpers (optional save) ---
  const STORE_KEY='gs_collection_v1';
  function maybePersistCollection(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(collection)); }catch{} }
  (function tryRestore(){ try{ const raw=localStorage.getItem(STORE_KEY); if(raw){ collection=JSON.parse(raw)||[]; $('collectionCount').textContent=String(collection.length); } }catch{} })();

  // --- copy buttons (SwiftUI/CSS) ---
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.copy-btn'); if(!btn) return;
    const id = btn.getAttribute('data-target'); const el = document.getElementById(id);
    const text = el ? el.innerText : '';
    navigator.clipboard.writeText(text).then(()=>{ btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',2000); });
  });

  // --- wire up events ---
  function wire(){
    [angleEl,cX,cY,sR,eR,aCX,aCY,aStart].forEach(el=>el.addEventListener('input',updateAll));
    $('addStop').addEventListener('click', ()=>{ stopsEl.appendChild(makeStopRow({color:'#4d4dff',pos:50,opacity:1})); updateAll(); });
    $('resetStops').addEventListener('click', initDefaults);

    typeLinear.addEventListener('change', ()=>{ linearControls.style.display='block'; radialControls.style.display='none'; angularControls.style.display='none'; updateAll(); });
    typeRadial.addEventListener('change',  ()=>{ linearControls.style.display='none';  radialControls.style.display='block'; angularControls.style.display='none'; updateAll(); });
    typeAngular.addEventListener('change', ()=>{ linearControls.style.display='none';  radialControls.style.display='none'; angularControls.style.display='block'; updateAll(); });

    $('downloadPNG').addEventListener('click', downloadPNG);
    $('downloadPack').addEventListener('click', downloadPack);
    $('addToCollection').addEventListener('click', addToCollection);
    $('exportSwift').addEventListener('click', exportSwift);
    $('exportCSS').addEventListener('click', exportCSS);
    $('exportJSON').addEventListener('click', exportJSON);
    $('clearCollection').addEventListener('click', ()=>{ if(confirm('Clear collection (this session only)?')) { collection=[]; $('collectionCount').textContent='0'; maybePersistCollection(); } });
    $('saveBrowser').addEventListener('click', ()=>{ if(confirm('Save your collection to this browser?')){ maybePersistCollection(); alert('Saved locally.'); } });
    $('clearSaved').addEventListener('click', ()=>{ if(confirm('Remove saved collection from this browser?')){ localStorage.removeItem(STORE_KEY); alert('Removed.'); } });
    $('copyEmailLink').addEventListener('click', (e)=>{ e.preventDefault(); navigator.clipboard.writeText('friends@preceptress.ai').then(()=>alert('üìã Email copied to clipboard: friends@preceptress.ai')); });
    $('importJSON').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });
  }

  function initDefaults(){
    stopsEl.innerHTML='';
    stopsEl.appendChild(makeStopRow({color:'#1a1a40',pos:0,opacity:1}));
    stopsEl.appendChild(makeStopRow({color:'#000000',pos:100,opacity:1}));
  }

  // boot
  (function boot(){ initDefaults(); wire(); updateAll(); })();
</script>

<script>
(() => {
  const miniPhone = document.getElementById('iphoneScreenMini');
  const cssMini   = document.getElementById('cssCodeMini');
  const swiftMini = document.getElementById('swiftCodeMini');

  // If your main preview & code blocks already exist, mirror them.
  const mainPreview = document.getElementById('preview');
  const cssMain     = document.getElementById('cssCode');    // optional
  const swiftMain   = document.getElementById('swiftCode');  // optional

  function syncOnce() {
    // 1) Background: prefer inline style on #preview; fallback to computed
    const bg = (mainPreview && mainPreview.style && mainPreview.style.background)
      ? mainPreview.style.background
      : (mainPreview ? getComputedStyle(mainPreview).backgroundImage : '');

    if (bg) {
      miniPhone.style.background = bg;
      cssMini.textContent = `background: ${bg};`;
    } else if (cssMain && cssMain.textContent) {
      // fallback: if your main CSS block already has the line
      cssMini.textContent = cssMain.textContent;
      // try to parse "background: ...;"
      const m = cssMain.textContent.match(/background:\s*(.*?);/);
      if (m) miniPhone.style.background = m[1];
    }

    // 2) Swift: if your main Swift code exists, mirror its text
    if (swiftMain && swiftMain.textContent) {
      swiftMini.textContent = swiftMain.textContent;
    } else if (!swiftMini.textContent) {
      // Minimal placeholder if main block isn't present
      swiftMini.textContent = "// SwiftUI gradient will appear here when available";
    }
  }

  // Observe changes on the main preview style to live-update the mini section
  if (mainPreview) {
    const mo = new MutationObserver(syncOnce);
    mo.observe(mainPreview, { attributes: true, attributeFilter: ['style'] });
  }

  // Also listen for generic user input changes to catch code updates
  document.addEventListener('input', syncOnce);
  document.addEventListener('change', syncOnce);

  // Initial paint
  syncOnce();

  // Reuse existing "Copy" button behavior if you have it; otherwise wire here
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.copy-btn');
    if (!btn) return;
    const id = btn.getAttribute('data-target');
    const el = document.getElementById(id);
    const txt = el ? el.innerText : '';
    navigator.clipboard.writeText(txt).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 2000);
    });
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
  // ---- Export iOS Demo (ZIP) ----
function swiftColorLine(hex, opacity=1) {
  // hex -> SwiftUI Color(red:..., green:..., blue:..., opacity:...)
  const { r,g,b,a } = hexToRgbA(hex, opacity);
  const f = (n)=> (n/255).toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
  const af = a.toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
  return `Color(red: ${f(r)}, green: ${f(g)}, blue: ${f(b)}, opacity: ${af})`;
}

function genThemeSwift(spec) {
  // Build SwiftUI Theme with a gradient that matches current spec
  const stops = spec.stops.map(s => swiftColorLine(s.color, s.opacity)).join(",\n            ");

  if (spec.type === 'linear') {
    return `import SwiftUI

struct Theme {
    static func gradient(angle: Double = \(Number(spec.angle|0))) -> LinearGradient {
        let colors: [Color] = [
            \(stops)
        ]
        let rad = angle * .pi / 180
        let vx = cos(rad), vy = sin(rad)
        let m  = max(abs(vx), abs(vy))
        let nx = vx / (m == 0 ? 1 : m)
        let ny = vy / (m == 0 ? 1 : m)
        let start = UnitPoint(x: 0.5 - 0.5 * nx, y: 0.5 - 0.5 * ny)
        let end   = UnitPoint(x: 0.5 + 0.5 * nx, y: 0.5 + 0.5 * ny)
        return LinearGradient(gradient: Gradient(colors: colors), startPoint: start, endPoint: end)
    }
}
`;
  } else if (spec.type === 'radial') {
    const cx = (Number(spec.centerX)/100).toFixed(3);
    const cy = (Number(spec.centerY)/100).toFixed(3);
    const sr = (Number(spec.startR)/100).toFixed(3);
    const er = (Number(spec.endR)/100).toFixed(3);
    return `import SwiftUI

struct Theme {
    static func gradient() -> RadialGradient {
        let colors: [Color] = [
            \(stops)
        ]
        return RadialGradient(
            gradient: Gradient(colors: colors),
            center: UnitPoint(x: \(cx), y: \(cy)),
            startRadius: \(sr),
            endRadius: \(er)
        )
    }
}
`;
  } else {
    const cx = (Number(spec.centerX)/100).toFixed(3);
    const cy = (Number(spec.centerY)/100).toFixed(3);
    const sa = Number(spec.startAngle|0);
    return `import SwiftUI

struct Theme {
    static func gradient(start: Angle = .degrees(\(sa))) -> AngularGradient {
        let colors: [Color] = [
            \(stops)
        ]
        return AngularGradient(
            gradient: Gradient(colors: colors),
            center: UnitPoint(x: \(cx), y: \(cy)),
            startAngle: start,
            endAngle: .degrees(start.degrees + 360)
        )
    }
}
`;
  }
}

function genContentViewSwift(spec) {
  // A tiny demo UI that shows the gradient and exposes the relevant control
  const header = `import SwiftUI

enum GType: String { case linear, radial, angular }

struct ContentView: View {
    @State private var gType: GType = .\(spec.type)
`;

  let bodyControls = ``;
  let previewView  = ``;

  if (spec.type === 'linear') {
    bodyControls = `    @State private var angle: Double = \(Number(spec.angle|0))

    var body: some View {
        VStack(spacing: 16) {
            ZStack {
                Theme.gradient(angle: angle)
                    .ignoresSafeArea()
                RoundedRectangle(cornerRadius: 22, style: .continuous)
                    .fill(.ultraThinMaterial)
                    .frame(height: 300)
                    .overlay(Text("Gradient Demo").font(.title3.bold()))
                    .padding()
            }
            .frame(height: 320)

            Text("Angle: \\(Int(angle))¬∞")
            Slider(value: $angle, in: 0...360, step: 1)
                .padding(.horizontal)

            Spacer()
        }
        .background(Color.black.opacity(0.96))
    }`;
  } else if (spec.type === 'radial') {
    bodyControls = `    var body: some View {
        VStack(spacing: 16) {
            ZStack {
                Theme.gradient()
                    .ignoresSafeArea()
                RoundedRectangle(cornerRadius: 22, style: .continuous)
                    .fill(.ultraThinMaterial)
                    .frame(height: 300)
                    .overlay(Text("Gradient Demo").font(.title3.bold()))
                    .padding()
            }
            .frame(height: 320)

            Text("Radial gradient (center/radii baked in)")

            Spacer()
        }
        .background(Color.black.opacity(0.96))
    }`;
  } else {
    bodyControls = `    @State private var start: Double = \(Number(spec.startAngle|0))

    var body: some View {
        VStack(spacing: 16) {
            ZStack {
                Theme.gradient(start: .degrees(start))
                    .ignoresSafeArea()
                RoundedRectangle(cornerRadius: 22, style: .continuous)
                    .fill(.ultraThinMaterial)
                    .frame(height: 300)
                    .overlay(Text("Gradient Demo").font(.title3.bold()))
                    .padding()
            }
            .frame(height: 320)

            Text("Start Angle: \\(Int(start))¬∞")
            Slider(value: $start, in: 0...360, step: 1)
                .padding(.horizontal)

            Spacer()
        }
        .background(Color.black.opacity(0.96))
    }`;
  }

  const footer = `

#Preview { ContentView() }`;

  return header + bodyControls + footer + "\n";
}

function genAppSwift() {
  return `import SwiftUI

@main
struct GradientDemoApp: App {
    var body: some Scene {
        WindowGroup { ContentView() }
    }
}
`;
}

function genReadme(spec) {
  const title = `# GradientDemo (SwiftUI)\n\n`;
  const desc  = `This demo was exported from Gradient Studio. It includes a SwiftUI gradient that matches your current design (${spec.type}).\n\n`;
  const steps = `## Run on iPhone (Xcode)\n1. Open **Xcode** ‚Üí **File > New > Project‚Ä¶** ‚Üí iOS **App** (SwiftUI, Swift).\n2. Name it **GradientDemo** (or anything you like).\n3. In the new project, **delete** the default \`ContentView.swift\`.\n4. **Drag** the exported files into the project root (check ‚ÄúCopy items if needed‚Äù):\n   - \`GradientDemoApp.swift\`\n   - \`ContentView.swift\`\n   - \`Theme.swift\`\n5. Select an iPhone simulator (or your device) and **Run**.\n\n`;
  const note  = `> The gradient colors, stops, and parameters were baked in at export time.\n`;

  return title + desc + steps + note;
}

async function exportIOSZip() {
  const spec = currentSpec();             // pulls your current gradient (type + params + stops)
  const zip  = new JSZip();

  zip.file("Theme.swift", genThemeSwift(spec));
  zip.file("ContentView.swift", genContentViewSwift(spec));
  zip.file("GradientDemoApp.swift", genAppSwift());
  zip.file("README.md", genReadme(spec));

  const blob = await zip.generateAsync({type: "blob"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const base = (document.getElementById('gradName')?.value || 'Gradient').replace(/\W+/g,'') || 'Gradient';
  a.download = `${base}-iOS-Demo.zip`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
</script>

</body>
</html>